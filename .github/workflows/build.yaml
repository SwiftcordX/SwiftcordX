name: Build Swiftcord Nightly (Xcode 14.2)

on:
  push:
  workflow_dispatch:

concurrency:
  group: ref-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-nightly:
    runs-on: macos-13
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      ##########################
      ## Select Xcode 14.2
      ##########################
      - name: Select Xcode 14.2
        run: |
          sudo xcode-select -s /Applications/Xcode_14.2.app/Contents/Developer
          xcodebuild -version
          xcode-select -p

      ##########################
      ## Build Swiftcord.app
      ##########################
      - name: Build with xcodebuild
        run: |
          mkdir -p build

          xcodebuild \
            -project Swiftcord.xcodeproj \
            -scheme Swiftcord \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO

          # иногда Release лежит в Release или Release-<platform>
          echo "Searching for Swiftcord.app..."
          find build/DerivedData/Build/Products -maxdepth 4 -name "Swiftcord.app" -print

          APP_PATH=$(find build/DerivedData/Build/Products -maxdepth 4 -type d -name "Swiftcord.app" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "❌ Swiftcord.app not found"
            echo "Products folder:"
            ls -R build/DerivedData/Build/Products || true
            exit 1
          fi

          echo "✅ Found app at: $APP_PATH"
          ditto "$APP_PATH" "build/Swiftcord.app"

      ##########################
      ## Upload Artifact
      ##########################
      - name: Upload Swiftcord.app artifact
        uses: actions/upload-artifact@v4
        with:
          name: Swiftcord-app-xcode14_2
          path: build/Swiftcord.app
